begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  *  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  * http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|tooling
operator|.
name|features
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStreamWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|StringWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Comparator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedHashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|bind
operator|.
name|JAXBException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|parsers
operator|.
name|ParserConfigurationException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|stream
operator|.
name|XMLStreamException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|features
operator|.
name|internal
operator|.
name|model
operator|.
name|Dependency
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|features
operator|.
name|internal
operator|.
name|model
operator|.
name|Feature
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|features
operator|.
name|internal
operator|.
name|model
operator|.
name|Bundle
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|features
operator|.
name|internal
operator|.
name|model
operator|.
name|Features
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|features
operator|.
name|internal
operator|.
name|model
operator|.
name|JaxbUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|karaf
operator|.
name|features
operator|.
name|internal
operator|.
name|model
operator|.
name|ObjectFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|Artifact
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|factory
operator|.
name|ArtifactFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|metadata
operator|.
name|ArtifactMetadataSource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|repository
operator|.
name|ArtifactRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|resolver
operator|.
name|ArtifactCollector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|resolver
operator|.
name|ArtifactNotFoundException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|resolver
operator|.
name|ArtifactResolutionException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|artifact
operator|.
name|resolver
operator|.
name|ArtifactResolutionResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|execution
operator|.
name|MavenSession
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|plugin
operator|.
name|Mojo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|plugin
operator|.
name|MojoExecutionException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|plugin
operator|.
name|MojoFailureException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|plugin
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|plugin
operator|.
name|logging
operator|.
name|SystemStreamLog
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|project
operator|.
name|MavenProject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|project
operator|.
name|MavenProjectHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|project
operator|.
name|artifact
operator|.
name|InvalidDependencyVersionException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|shared
operator|.
name|dependency
operator|.
name|tree
operator|.
name|DependencyNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|shared
operator|.
name|dependency
operator|.
name|tree
operator|.
name|DependencyTreeResolutionListener
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|shared
operator|.
name|filtering
operator|.
name|MavenFileFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|shared
operator|.
name|filtering
operator|.
name|MavenFilteringException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|maven
operator|.
name|shared
operator|.
name|filtering
operator|.
name|MavenResourcesFiltering
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|plexus
operator|.
name|logging
operator|.
name|AbstractLogEnabled
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|plexus
operator|.
name|util
operator|.
name|ReaderFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|codehaus
operator|.
name|plexus
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_comment
comment|/**  * Generates the features XML file  *  * @version $Revision: 1.1 $  * @goal generate-features-xml2  * @phase compile  * @requiresDependencyResolution runtime  * @inheritByDefault true  * @description Generates the features XML file  */
end_comment

begin_class
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
specifier|public
class|class
name|GenerateFeaturesXmlMojo2
extends|extends
name|AbstractLogEnabled
implements|implements
name|Mojo
block|{
specifier|private
specifier|static
specifier|final
name|String
name|FEATURE_CLASSIFIER
init|=
literal|"feature"
decl_stmt|;
comment|/**      * The dependency tree builder to use.      *      * @component      * @required      * @readonly      */
comment|//    private DependencyTreeBuilder dependencyTreeBuilder;
comment|/**      * The (optional) input feature.file to extend      *      * @parameter default-value="${project.build.directory}/src/main/feature/feature.xml"      */
specifier|private
name|File
name|inputFile
decl_stmt|;
comment|/**      * The file to generate      *      * @parameter default-value="${project.build.directory}/feature/feature.xml"      */
specifier|private
name|File
name|outputFile
decl_stmt|;
comment|/**      * The resolver to use for the feature.  Normally null or "OBR" or "(OBR)"      *      * @parameter default-value="${resolver}"      */
specifier|private
name|String
name|resolver
decl_stmt|;
comment|/**      * The artifact type for attaching the generated file to the project      *      * @parameter default-value="xml"      */
specifier|private
name|String
name|attachmentArtifactType
init|=
literal|"xml"
decl_stmt|;
comment|/**      * The artifact classifier for attaching the generated file to the project      *      * @parameter default-value="features"      */
specifier|private
name|String
name|attachmentArtifactClassifier
init|=
literal|"features"
decl_stmt|;
comment|/**      * If false, feature dependencies are added to the assembled feature as dependencies.      * If true, feature dependencies xml descriptors are read and their contents added to the features descriptor under assembly.      *      * @parameter default-value="${aggregateFeatures}"      */
specifier|private
name|boolean
name|aggregateFeatures
init|=
literal|false
decl_stmt|;
comment|//new
comment|/**      * The maven project.      *      * @parameter expression="${project}"      * @required      * @readonly      */
specifier|protected
name|MavenProject
name|project
decl_stmt|;
comment|/**      * The maven project's helper.      *      * @component      * @required      * @readonly      */
specifier|protected
name|MavenProjectHelper
name|projectHelper
decl_stmt|;
comment|/**      * The artifact factory to use.      *      * @component      * @required      * @readonly      */
specifier|protected
name|ArtifactFactory
name|artifactFactory
decl_stmt|;
comment|/**      * The artifact repository to use.      *      * @parameter expression="${localRepository}"      * @required      * @readonly      */
specifier|private
name|ArtifactRepository
name|localRepository
decl_stmt|;
comment|/**      * The artifact metadata source to use.      *      * @component      * @required      * @readonly      */
specifier|private
name|ArtifactMetadataSource
name|artifactMetadataSource
decl_stmt|;
comment|/**      * The artifact collector to use.      *      * @component      * @required      * @readonly      */
specifier|private
name|ArtifactCollector
name|artifactCollector
decl_stmt|;
comment|//all dependencies
specifier|protected
name|Set
argument_list|<
name|Artifact
argument_list|>
name|dependencyArtifacts
decl_stmt|;
comment|//dependencies we are interested in
specifier|protected
name|Set
argument_list|<
name|Artifact
argument_list|>
name|localDependencies
decl_stmt|;
comment|//log of what happened during search
specifier|protected
name|String
name|treeListing
decl_stmt|;
comment|//maven log
specifier|private
name|Log
name|log
decl_stmt|;
specifier|public
name|void
name|execute
parameter_list|()
throws|throws
name|MojoExecutionException
throws|,
name|MojoFailureException
block|{
try|try
block|{
name|getDependencies
argument_list|(
name|project
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|File
name|dir
init|=
name|outputFile
operator|.
name|getParentFile
argument_list|()
decl_stmt|;
if|if
condition|(
name|dir
operator|.
name|isDirectory
argument_list|()
operator|||
name|dir
operator|.
name|mkdirs
argument_list|()
condition|)
block|{
name|PrintStream
name|out
init|=
operator|new
name|PrintStream
argument_list|(
operator|new
name|FileOutputStream
argument_list|(
name|outputFile
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|writeFeatures
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// now lets attach it
name|projectHelper
operator|.
name|attachArtifact
argument_list|(
name|project
argument_list|,
name|attachmentArtifactType
argument_list|,
name|attachmentArtifactClassifier
argument_list|,
name|outputFile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
literal|"Could not create directory for features file: "
operator|+
name|dir
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|getLogger
argument_list|()
operator|.
name|error
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
literal|"Unable to create features.xml file: "
operator|+
name|e
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
comment|/*      * Write all project dependencies as feature      */
specifier|private
name|void
name|writeFeatures
parameter_list|(
name|PrintStream
name|out
parameter_list|)
throws|throws
name|ArtifactResolutionException
throws|,
name|ArtifactNotFoundException
throws|,
name|IOException
throws|,
name|JAXBException
throws|,
name|SAXException
throws|,
name|ParserConfigurationException
throws|,
name|XMLStreamException
throws|,
name|MojoExecutionException
block|{
name|getLogger
argument_list|()
operator|.
name|info
argument_list|(
literal|"Step 4 : Generating "
operator|+
name|outputFile
operator|.
name|getAbsolutePath
argument_list|()
argument_list|)
expr_stmt|;
comment|//read in an existing feature.xml
name|ObjectFactory
name|objectFactory
init|=
operator|new
name|ObjectFactory
argument_list|()
decl_stmt|;
name|Features
name|features
decl_stmt|;
if|if
condition|(
name|inputFile
operator|.
name|exists
argument_list|()
condition|)
block|{
name|features
operator|=
name|readFeaturesFile
argument_list|(
name|inputFile
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|features
operator|=
name|objectFactory
operator|.
name|createFeaturesRoot
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|features
operator|.
name|getName
argument_list|()
operator|==
literal|null
condition|)
block|{
name|features
operator|.
name|setName
argument_list|(
name|project
operator|.
name|getArtifactId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Feature
name|feature
init|=
literal|null
decl_stmt|;
for|for
control|(
name|Feature
name|test
range|:
name|features
operator|.
name|getFeature
argument_list|()
control|)
block|{
if|if
condition|(
name|test
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|project
operator|.
name|getArtifactId
argument_list|()
argument_list|)
condition|)
block|{
name|feature
operator|=
name|test
expr_stmt|;
block|}
block|}
if|if
condition|(
name|feature
operator|==
literal|null
condition|)
block|{
name|feature
operator|=
name|objectFactory
operator|.
name|createFeature
argument_list|()
expr_stmt|;
name|feature
operator|.
name|setName
argument_list|(
name|project
operator|.
name|getArtifactId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|feature
operator|.
name|setVersion
argument_list|(
name|project
operator|.
name|getArtifact
argument_list|()
operator|.
name|getBaseVersion
argument_list|()
argument_list|)
expr_stmt|;
name|feature
operator|.
name|setResolver
argument_list|(
name|resolver
argument_list|)
expr_stmt|;
for|for
control|(
name|Artifact
name|artifact
range|:
name|localDependencies
control|)
block|{
if|if
condition|(
name|isFeature
argument_list|(
name|artifact
argument_list|)
condition|)
block|{
if|if
condition|(
name|aggregateFeatures
operator|&&
name|FEATURE_CLASSIFIER
operator|.
name|equals
argument_list|(
name|artifact
operator|.
name|getClassifier
argument_list|()
argument_list|)
condition|)
block|{
name|File
name|featuresFile
init|=
name|artifact
operator|.
name|getFile
argument_list|()
decl_stmt|;
if|if
condition|(
name|featuresFile
operator|==
literal|null
operator|||
operator|!
name|featuresFile
operator|.
name|exists
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
literal|"Cannot locate file for feature: "
operator|+
name|artifact
operator|+
literal|" at "
operator|+
name|featuresFile
argument_list|)
throw|;
block|}
name|Features
name|includedFeatures
init|=
name|readFeaturesFile
argument_list|(
name|inputFile
argument_list|)
decl_stmt|;
comment|//TODO check for duplicates?
name|features
operator|.
name|getFeature
argument_list|()
operator|.
name|addAll
argument_list|(
name|includedFeatures
operator|.
name|getFeature
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Dependency
name|dependency
init|=
name|objectFactory
operator|.
name|createDependency
argument_list|()
decl_stmt|;
name|dependency
operator|.
name|setName
argument_list|(
name|artifact
operator|.
name|getArtifactId
argument_list|()
argument_list|)
expr_stmt|;
comment|//TODO convert to osgi version?
name|dependency
operator|.
name|setVersion
argument_list|(
name|artifact
operator|.
name|getVersion
argument_list|()
argument_list|)
expr_stmt|;
name|feature
operator|.
name|getDependencies
argument_list|()
operator|.
name|add
argument_list|(
name|dependency
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|String
name|bundleName
decl_stmt|;
if|if
condition|(
name|artifact
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
literal|"jar"
argument_list|)
condition|)
block|{
name|bundleName
operator|=
name|String
operator|.
name|format
argument_list|(
literal|"mvn:%s/%s/%s"
argument_list|,
name|artifact
operator|.
name|getGroupId
argument_list|()
argument_list|,
name|artifact
operator|.
name|getArtifactId
argument_list|()
argument_list|,
name|artifact
operator|.
name|getBaseVersion
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bundleName
operator|=
name|String
operator|.
name|format
argument_list|(
literal|"mvn:%s/%s/%s/%s"
argument_list|,
name|artifact
operator|.
name|getGroupId
argument_list|()
argument_list|,
name|artifact
operator|.
name|getArtifactId
argument_list|()
argument_list|,
name|artifact
operator|.
name|getBaseVersion
argument_list|()
argument_list|,
name|artifact
operator|.
name|getType
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Bundle
name|bundle
init|=
name|objectFactory
operator|.
name|createBundle
argument_list|()
decl_stmt|;
name|bundle
operator|.
name|setLocation
argument_list|(
name|bundleName
argument_list|)
expr_stmt|;
if|if
condition|(
literal|"runtime"
operator|.
name|equals
argument_list|(
name|artifact
operator|.
name|getScope
argument_list|()
argument_list|)
condition|)
block|{
name|bundle
operator|.
name|setDependency
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
name|feature
operator|.
name|getBundle
argument_list|()
operator|.
name|add
argument_list|(
name|bundle
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
operator|!
name|feature
operator|.
name|getBundle
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|feature
operator|.
name|getDependencies
argument_list|()
operator|.
name|isEmpty
argument_list|()
operator|)
operator|&&
operator|!
name|features
operator|.
name|getFeature
argument_list|()
operator|.
name|contains
argument_list|(
name|feature
argument_list|)
condition|)
block|{
name|features
operator|.
name|getFeature
argument_list|()
operator|.
name|add
argument_list|(
name|feature
argument_list|)
expr_stmt|;
block|}
name|JaxbUtil
operator|.
name|marshal
argument_list|(
name|Features
operator|.
name|class
argument_list|,
name|features
argument_list|,
name|out
argument_list|)
expr_stmt|;
try|try
block|{
name|checkChanges
argument_list|(
name|features
argument_list|,
name|objectFactory
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
literal|"Features contents have changed"
argument_list|,
name|e
argument_list|)
throw|;
block|}
name|getLogger
argument_list|()
operator|.
name|info
argument_list|(
literal|"...done!"
argument_list|)
expr_stmt|;
block|}
specifier|private
name|Features
name|readFeaturesFile
parameter_list|(
name|File
name|featuresFile
parameter_list|)
throws|throws
name|XMLStreamException
throws|,
name|JAXBException
throws|,
name|IOException
block|{
name|Features
name|features
decl_stmt|;
name|InputStream
name|in
init|=
operator|new
name|FileInputStream
argument_list|(
name|featuresFile
argument_list|)
decl_stmt|;
try|try
block|{
name|features
operator|=
name|JaxbUtil
operator|.
name|unmarshal
argument_list|(
name|in
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
return|return
name|features
return|;
block|}
comment|//artifact search code adapted from geronimo car plugin
specifier|protected
name|void
name|getDependencies
parameter_list|(
name|MavenProject
name|project
parameter_list|,
name|boolean
name|useTransitiveDependencies
parameter_list|)
throws|throws
name|MojoExecutionException
block|{
name|DependencyTreeResolutionListener
name|listener
init|=
operator|new
name|DependencyTreeResolutionListener
argument_list|(
name|getLogger
argument_list|()
argument_list|)
decl_stmt|;
name|DependencyNode
name|rootNode
decl_stmt|;
try|try
block|{
name|Map
name|managedVersions
init|=
name|project
operator|.
name|getManagedVersionMap
argument_list|()
decl_stmt|;
name|Set
name|dependencyArtifacts
init|=
name|project
operator|.
name|getDependencyArtifacts
argument_list|()
decl_stmt|;
if|if
condition|(
name|dependencyArtifacts
operator|==
literal|null
condition|)
block|{
name|dependencyArtifacts
operator|=
name|project
operator|.
name|createArtifacts
argument_list|(
name|artifactFactory
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
name|ArtifactResolutionResult
name|result
init|=
name|artifactCollector
operator|.
name|collect
argument_list|(
name|dependencyArtifacts
argument_list|,
name|project
operator|.
name|getArtifact
argument_list|()
argument_list|,
name|managedVersions
argument_list|,
name|localRepository
argument_list|,
name|project
operator|.
name|getRemoteArtifactRepositories
argument_list|()
argument_list|,
name|artifactMetadataSource
argument_list|,
literal|null
argument_list|,
name|Collections
operator|.
name|singletonList
argument_list|(
name|listener
argument_list|)
argument_list|)
decl_stmt|;
name|this
operator|.
name|dependencyArtifacts
operator|=
name|result
operator|.
name|getArtifacts
argument_list|()
expr_stmt|;
name|rootNode
operator|=
name|listener
operator|.
name|getRootNode
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ArtifactResolutionException
name|exception
parameter_list|)
block|{
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
literal|"Cannot build project dependency tree"
argument_list|,
name|exception
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InvalidDependencyVersionException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
literal|"Invalid dependency version for artifact "
operator|+
name|project
operator|.
name|getArtifact
argument_list|()
argument_list|)
throw|;
block|}
name|Scanner
name|scanner
init|=
operator|new
name|Scanner
argument_list|()
decl_stmt|;
name|scanner
operator|.
name|scan
argument_list|(
name|rootNode
argument_list|,
name|useTransitiveDependencies
argument_list|)
expr_stmt|;
name|localDependencies
operator|=
name|scanner
operator|.
name|localDependencies
operator|.
name|keySet
argument_list|()
expr_stmt|;
name|treeListing
operator|=
name|scanner
operator|.
name|getLog
argument_list|()
expr_stmt|;
block|}
specifier|public
name|void
name|setLog
parameter_list|(
name|Log
name|log
parameter_list|)
block|{
name|this
operator|.
name|log
operator|=
name|log
expr_stmt|;
block|}
specifier|public
name|Log
name|getLog
parameter_list|()
block|{
if|if
condition|(
name|log
operator|==
literal|null
condition|)
block|{
name|setLog
argument_list|(
operator|new
name|SystemStreamLog
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|log
return|;
block|}
specifier|private
specifier|static
class|class
name|Scanner
block|{
specifier|private
specifier|static
enum|enum
name|Accept
block|{
name|ACCEPT
argument_list|(
literal|true
argument_list|,
literal|true
argument_list|)
block|,
name|PROVIDED
argument_list|(
literal|true
argument_list|,
literal|false
argument_list|)
block|,
name|STOP
argument_list|(
literal|false
argument_list|,
literal|false
argument_list|)
block|;
specifier|private
specifier|final
name|boolean
name|more
decl_stmt|;
specifier|private
specifier|final
name|boolean
name|local
decl_stmt|;
specifier|private
name|Accept
parameter_list|(
name|boolean
name|more
parameter_list|,
name|boolean
name|local
parameter_list|)
block|{
name|this
operator|.
name|more
operator|=
name|more
expr_stmt|;
name|this
operator|.
name|local
operator|=
name|local
expr_stmt|;
block|}
specifier|public
name|boolean
name|isContinue
parameter_list|()
block|{
return|return
name|more
return|;
block|}
specifier|public
name|boolean
name|isLocal
parameter_list|()
block|{
return|return
name|local
return|;
block|}
block|}
comment|//all the dependencies needed for this car, with provided dependencies removed
specifier|private
specifier|final
name|Map
argument_list|<
name|Artifact
argument_list|,
name|Set
argument_list|<
name|Artifact
argument_list|>
argument_list|>
name|localDependencies
init|=
operator|new
name|LinkedHashMap
argument_list|<
name|Artifact
argument_list|,
name|Set
argument_list|<
name|Artifact
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
comment|//dependencies from ancestor cars, to be removed from localDependencies.
specifier|private
specifier|final
name|Set
argument_list|<
name|Artifact
argument_list|>
name|carDependencies
init|=
operator|new
name|LinkedHashSet
argument_list|<
name|Artifact
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|StringBuilder
name|log
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
specifier|public
name|void
name|scan
parameter_list|(
name|DependencyNode
name|rootNode
parameter_list|,
name|boolean
name|useTransitiveDependencies
parameter_list|)
block|{
name|Set
argument_list|<
name|Artifact
argument_list|>
name|children
init|=
operator|new
name|LinkedHashSet
argument_list|<
name|Artifact
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|DependencyNode
name|child
range|:
operator|(
name|List
argument_list|<
name|DependencyNode
argument_list|>
operator|)
name|rootNode
operator|.
name|getChildren
argument_list|()
control|)
block|{
name|scan
argument_list|(
name|child
argument_list|,
name|Accept
operator|.
name|ACCEPT
argument_list|,
name|useTransitiveDependencies
argument_list|,
literal|false
argument_list|,
literal|""
argument_list|,
name|children
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|useTransitiveDependencies
condition|)
block|{
name|localDependencies
operator|.
name|keySet
argument_list|()
operator|.
name|removeAll
argument_list|(
name|carDependencies
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|scan
parameter_list|(
name|DependencyNode
name|rootNode
parameter_list|,
name|Accept
name|parentAccept
parameter_list|,
name|boolean
name|useTransitiveDependencies
parameter_list|,
name|boolean
name|isFromCar
parameter_list|,
name|String
name|indent
parameter_list|,
name|Set
argument_list|<
name|Artifact
argument_list|>
name|parentsChildren
parameter_list|)
block|{
name|Artifact
name|artifact
init|=
name|getArtifact
argument_list|(
name|rootNode
argument_list|)
decl_stmt|;
name|Accept
name|accept
init|=
name|accept
argument_list|(
name|artifact
argument_list|,
name|parentAccept
argument_list|)
decl_stmt|;
if|if
condition|(
name|accept
operator|.
name|isContinue
argument_list|()
condition|)
block|{
name|Set
argument_list|<
name|Artifact
argument_list|>
name|children
init|=
name|localDependencies
operator|.
name|get
argument_list|(
name|artifact
argument_list|)
decl_stmt|;
if|if
condition|(
name|isFromCar
condition|)
block|{
if|if
condition|(
operator|!
name|isFeature
argument_list|(
name|artifact
argument_list|)
condition|)
block|{
name|log
operator|.
name|append
argument_list|(
name|indent
argument_list|)
operator|.
name|append
argument_list|(
literal|"from feature:"
argument_list|)
operator|.
name|append
argument_list|(
name|artifact
argument_list|)
operator|.
name|append
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|carDependencies
operator|.
name|add
argument_list|(
name|artifact
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
operator|.
name|append
argument_list|(
name|indent
argument_list|)
operator|.
name|append
argument_list|(
literal|"is feature:"
argument_list|)
operator|.
name|append
argument_list|(
name|artifact
argument_list|)
operator|.
name|append
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|log
operator|.
name|append
argument_list|(
name|indent
argument_list|)
operator|.
name|append
argument_list|(
literal|"local:"
argument_list|)
operator|.
name|append
argument_list|(
name|artifact
argument_list|)
operator|.
name|append
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|carDependencies
operator|.
name|contains
argument_list|(
name|artifact
argument_list|)
condition|)
block|{
name|log
operator|.
name|append
argument_list|(
name|indent
argument_list|)
operator|.
name|append
argument_list|(
literal|"already in feature, returning:"
argument_list|)
operator|.
name|append
argument_list|(
name|artifact
argument_list|)
operator|.
name|append
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|parentsChildren
operator|.
name|add
argument_list|(
name|artifact
argument_list|)
expr_stmt|;
return|return;
block|}
name|parentsChildren
operator|.
name|add
argument_list|(
name|artifact
argument_list|)
expr_stmt|;
if|if
condition|(
name|children
operator|==
literal|null
condition|)
block|{
name|children
operator|=
operator|new
name|LinkedHashSet
argument_list|<
name|Artifact
argument_list|>
argument_list|()
expr_stmt|;
name|localDependencies
operator|.
name|put
argument_list|(
name|artifact
argument_list|,
name|children
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isFeature
argument_list|(
name|artifact
argument_list|)
operator|||
operator|!
name|useTransitiveDependencies
condition|)
block|{
name|isFromCar
operator|=
literal|true
expr_stmt|;
block|}
block|}
for|for
control|(
name|DependencyNode
name|child
range|:
operator|(
name|List
argument_list|<
name|DependencyNode
argument_list|>
operator|)
name|rootNode
operator|.
name|getChildren
argument_list|()
control|)
block|{
name|scan
argument_list|(
name|child
argument_list|,
name|accept
argument_list|,
name|useTransitiveDependencies
argument_list|,
name|isFromCar
argument_list|,
name|indent
operator|+
literal|"  "
argument_list|,
name|children
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|String
name|getLog
parameter_list|()
block|{
return|return
name|log
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|private
name|Artifact
name|getArtifact
parameter_list|(
name|DependencyNode
name|rootNode
parameter_list|)
block|{
name|Artifact
name|artifact
init|=
name|rootNode
operator|.
name|getArtifact
argument_list|()
decl_stmt|;
if|if
condition|(
name|rootNode
operator|.
name|getRelatedArtifact
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|artifact
operator|=
name|rootNode
operator|.
name|getRelatedArtifact
argument_list|()
expr_stmt|;
block|}
return|return
name|artifact
return|;
block|}
specifier|private
name|Accept
name|accept
parameter_list|(
name|Artifact
name|dependency
parameter_list|,
name|Accept
name|previous
parameter_list|)
block|{
comment|//            if (dependency.getGroupId().startsWith("org.apache.geronimo.genesis")) {
comment|//                return Accept.STOP;
comment|//            }
name|String
name|scope
init|=
name|dependency
operator|.
name|getScope
argument_list|()
decl_stmt|;
if|if
condition|(
name|scope
operator|==
literal|null
operator|||
literal|"runtime"
operator|.
name|equalsIgnoreCase
argument_list|(
name|scope
argument_list|)
operator|||
literal|"compile"
operator|.
name|equalsIgnoreCase
argument_list|(
name|scope
argument_list|)
condition|)
block|{
return|return
name|previous
return|;
block|}
return|return
name|Accept
operator|.
name|STOP
return|;
block|}
block|}
specifier|private
specifier|static
name|boolean
name|isFeature
parameter_list|(
name|Artifact
name|artifact
parameter_list|)
block|{
return|return
name|artifact
operator|.
name|getType
argument_list|()
operator|.
name|equals
argument_list|(
literal|"kar"
argument_list|)
operator|||
name|FEATURE_CLASSIFIER
operator|.
name|equals
argument_list|(
name|artifact
operator|.
name|getClassifier
argument_list|()
argument_list|)
return|;
block|}
comment|//------------------------------------------------------------------------//
comment|// dependency change detection
comment|/**      * Whether to look for changed dependencies at all      *      * @parameter      */
specifier|private
name|boolean
name|checkDependencyChange
decl_stmt|;
comment|/**      * Whether to fail on changed dependencies      *      * @parameter      */
specifier|private
name|boolean
name|warnOnDependencyChange
decl_stmt|;
comment|/**      * Whether to show changed dependencies in log      *      * @parameter      */
specifier|private
name|boolean
name|logDependencyChanges
decl_stmt|;
comment|/**      * Whether to overwrite dependencies.xml if it has changed      *      * @parameter      */
specifier|private
name|boolean
name|overwriteChangedDependencies
decl_stmt|;
comment|/**      * Location of existing dependency file.      *      * @parameter expression="${basedir}/src/main/history/dependencies.xml"      * @required      */
specifier|private
name|File
name|dependencyFile
decl_stmt|;
comment|/**      * Location of filtered dependency file.      *      * @parameter expression="${basedir}/target/history/dependencies.xml"      * @required      */
specifier|private
name|File
name|filteredDependencyFile
decl_stmt|;
comment|//filtering support
comment|/**      * The character encoding scheme to be applied when filtering resources.      *      * @parameter expression="${encoding}" default-value="${project.build.sourceEncoding}"      */
specifier|protected
name|String
name|encoding
decl_stmt|;
comment|/**      * @component role="org.apache.maven.shared.filtering.MavenResourcesFiltering" role-hint="default"      * @required      */
specifier|protected
name|MavenResourcesFiltering
name|mavenResourcesFiltering
decl_stmt|;
comment|/**      * @parameter expression="${session}"      * @readonly      * @required      */
specifier|protected
name|MavenSession
name|session
decl_stmt|;
comment|/**      * Expression preceded with the String won't be interpolated      * \${foo} will be replaced with ${foo}      *      * @parameter expression="${maven.resources.escapeString}"      * @since 2.3      */
specifier|protected
name|String
name|escapeString
init|=
literal|"\\"
decl_stmt|;
comment|/**      * @plexus.requirement role-hint="default"      * @component      * @required      */
specifier|protected
name|MavenFileFilter
name|mavenFileFilter
decl_stmt|;
comment|/**      * System properties.      *      * @parameter      */
specifier|protected
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|systemProperties
decl_stmt|;
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|previousSystemProperties
decl_stmt|;
specifier|private
name|void
name|checkChanges
parameter_list|(
name|Features
name|newFeatures
parameter_list|,
name|ObjectFactory
name|objectFactory
parameter_list|)
throws|throws
name|Exception
throws|,
name|IOException
throws|,
name|JAXBException
throws|,
name|XMLStreamException
block|{
if|if
condition|(
name|checkDependencyChange
condition|)
block|{
comment|//combine all the dependencies to one feature and strip out versions
name|Features
name|features
init|=
name|objectFactory
operator|.
name|createFeaturesRoot
argument_list|()
decl_stmt|;
name|features
operator|.
name|setName
argument_list|(
name|newFeatures
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|Feature
name|feature
init|=
name|objectFactory
operator|.
name|createFeature
argument_list|()
decl_stmt|;
name|features
operator|.
name|getFeature
argument_list|()
operator|.
name|add
argument_list|(
name|feature
argument_list|)
expr_stmt|;
for|for
control|(
name|Feature
name|f
range|:
name|newFeatures
operator|.
name|getFeature
argument_list|()
control|)
block|{
for|for
control|(
name|Bundle
name|b
range|:
name|f
operator|.
name|getBundle
argument_list|()
control|)
block|{
name|Bundle
name|bundle
init|=
name|objectFactory
operator|.
name|createBundle
argument_list|()
decl_stmt|;
name|bundle
operator|.
name|setLocation
argument_list|(
name|b
operator|.
name|getLocation
argument_list|()
argument_list|)
expr_stmt|;
name|feature
operator|.
name|getBundle
argument_list|()
operator|.
name|add
argument_list|(
name|bundle
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Dependency
name|d
range|:
name|f
operator|.
name|getFeature
argument_list|()
control|)
block|{
name|Dependency
name|dependency
init|=
name|objectFactory
operator|.
name|createDependency
argument_list|()
decl_stmt|;
name|dependency
operator|.
name|setName
argument_list|(
name|d
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|feature
operator|.
name|getFeature
argument_list|()
operator|.
name|add
argument_list|(
name|dependency
argument_list|)
expr_stmt|;
block|}
block|}
name|Collections
operator|.
name|sort
argument_list|(
name|feature
operator|.
name|getBundle
argument_list|()
argument_list|,
operator|new
name|Comparator
argument_list|<
name|Bundle
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|Bundle
name|bundle
parameter_list|,
name|Bundle
name|bundle1
parameter_list|)
block|{
return|return
name|bundle
operator|.
name|getLocation
argument_list|()
operator|.
name|compareTo
argument_list|(
name|bundle1
operator|.
name|getLocation
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
expr_stmt|;
name|Collections
operator|.
name|sort
argument_list|(
name|feature
operator|.
name|getFeature
argument_list|()
argument_list|,
operator|new
name|Comparator
argument_list|<
name|Dependency
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|Dependency
name|dependency
parameter_list|,
name|Dependency
name|dependency1
parameter_list|)
block|{
return|return
name|dependency
operator|.
name|getName
argument_list|()
operator|.
name|compareTo
argument_list|(
name|dependency1
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
expr_stmt|;
if|if
condition|(
name|dependencyFile
operator|.
name|exists
argument_list|()
condition|)
block|{
comment|//filter dependencies file
name|filter
argument_list|(
name|dependencyFile
argument_list|,
name|filteredDependencyFile
argument_list|)
expr_stmt|;
comment|//read dependency types, convert to dependencies, compare.
name|Features
name|oldfeatures
init|=
name|readFeaturesFile
argument_list|(
name|filteredDependencyFile
argument_list|)
decl_stmt|;
name|Feature
name|oldFeature
init|=
name|oldfeatures
operator|.
name|getFeature
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Bundle
argument_list|>
name|addedBundles
init|=
operator|new
name|ArrayList
argument_list|<
name|Bundle
argument_list|>
argument_list|(
name|feature
operator|.
name|getBundle
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Bundle
argument_list|>
name|removedBundles
init|=
operator|new
name|ArrayList
argument_list|<
name|Bundle
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Bundle
name|test
range|:
name|oldFeature
operator|.
name|getBundle
argument_list|()
control|)
block|{
name|boolean
name|t1
init|=
name|addedBundles
operator|.
name|contains
argument_list|(
name|test
argument_list|)
decl_stmt|;
name|int
name|s1
init|=
name|addedBundles
operator|.
name|size
argument_list|()
decl_stmt|;
name|boolean
name|t2
init|=
name|addedBundles
operator|.
name|remove
argument_list|(
name|test
argument_list|)
decl_stmt|;
name|int
name|s2
init|=
name|addedBundles
operator|.
name|size
argument_list|()
decl_stmt|;
if|if
condition|(
name|t1
operator|!=
name|t2
condition|)
block|{
name|getLogger
argument_list|()
operator|.
name|warn
argument_list|(
literal|"dependencies.contains: "
operator|+
name|t1
operator|+
literal|", dependencies.remove(test): "
operator|+
name|t2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t1
operator|==
operator|(
name|s1
operator|==
name|s2
operator|)
condition|)
block|{
name|getLogger
argument_list|()
operator|.
name|warn
argument_list|(
literal|"dependencies.contains: "
operator|+
name|t1
operator|+
literal|", size before: "
operator|+
name|s1
operator|+
literal|", size after: "
operator|+
name|s2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|t2
condition|)
block|{
name|removedBundles
operator|.
name|add
argument_list|(
name|test
argument_list|)
expr_stmt|;
block|}
block|}
name|List
argument_list|<
name|Dependency
argument_list|>
name|addedDependencys
init|=
operator|new
name|ArrayList
argument_list|<
name|Dependency
argument_list|>
argument_list|(
name|feature
operator|.
name|getFeature
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Dependency
argument_list|>
name|removedDependencys
init|=
operator|new
name|ArrayList
argument_list|<
name|Dependency
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Dependency
name|test
range|:
name|oldFeature
operator|.
name|getFeature
argument_list|()
control|)
block|{
name|boolean
name|t1
init|=
name|addedDependencys
operator|.
name|contains
argument_list|(
name|test
argument_list|)
decl_stmt|;
name|int
name|s1
init|=
name|addedDependencys
operator|.
name|size
argument_list|()
decl_stmt|;
name|boolean
name|t2
init|=
name|addedDependencys
operator|.
name|remove
argument_list|(
name|test
argument_list|)
decl_stmt|;
name|int
name|s2
init|=
name|addedDependencys
operator|.
name|size
argument_list|()
decl_stmt|;
if|if
condition|(
name|t1
operator|!=
name|t2
condition|)
block|{
name|getLogger
argument_list|()
operator|.
name|warn
argument_list|(
literal|"dependencies.contains: "
operator|+
name|t1
operator|+
literal|", dependencies.remove(test): "
operator|+
name|t2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t1
operator|==
operator|(
name|s1
operator|==
name|s2
operator|)
condition|)
block|{
name|getLogger
argument_list|()
operator|.
name|warn
argument_list|(
literal|"dependencies.contains: "
operator|+
name|t1
operator|+
literal|", size before: "
operator|+
name|s1
operator|+
literal|", size after: "
operator|+
name|s2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|t2
condition|)
block|{
name|removedDependencys
operator|.
name|add
argument_list|(
name|test
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|addedBundles
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|removedBundles
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|addedDependencys
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|removedDependencys
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|saveDependencyChanges
argument_list|(
name|addedBundles
argument_list|,
name|removedBundles
argument_list|,
name|addedDependencys
argument_list|,
name|removedDependencys
argument_list|,
name|objectFactory
argument_list|)
expr_stmt|;
if|if
condition|(
name|overwriteChangedDependencies
condition|)
block|{
name|writeDependencies
argument_list|(
name|features
argument_list|,
name|dependencyFile
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|writeDependencies
argument_list|(
name|features
argument_list|,
name|dependencyFile
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|protected
name|void
name|saveDependencyChanges
parameter_list|(
name|Collection
argument_list|<
name|Bundle
argument_list|>
name|addedBundles
parameter_list|,
name|Collection
argument_list|<
name|Bundle
argument_list|>
name|removedBundles
parameter_list|,
name|Collection
argument_list|<
name|Dependency
argument_list|>
name|addedDependencys
parameter_list|,
name|Collection
argument_list|<
name|Dependency
argument_list|>
name|removedDependencys
parameter_list|,
name|ObjectFactory
name|objectFactory
parameter_list|)
throws|throws
name|Exception
block|{
name|File
name|addedFile
init|=
operator|new
name|File
argument_list|(
name|filteredDependencyFile
operator|.
name|getParentFile
argument_list|()
argument_list|,
literal|"dependencies.added.xml"
argument_list|)
decl_stmt|;
name|Features
name|added
init|=
name|toFeatures
argument_list|(
name|addedBundles
argument_list|,
name|addedDependencys
argument_list|,
name|objectFactory
argument_list|)
decl_stmt|;
name|writeDependencies
argument_list|(
name|added
argument_list|,
name|addedFile
argument_list|)
expr_stmt|;
name|File
name|removedFile
init|=
operator|new
name|File
argument_list|(
name|filteredDependencyFile
operator|.
name|getParentFile
argument_list|()
argument_list|,
literal|"dependencies.removed.xml"
argument_list|)
decl_stmt|;
name|Features
name|removed
init|=
name|toFeatures
argument_list|(
name|removedBundles
argument_list|,
name|removedDependencys
argument_list|,
name|objectFactory
argument_list|)
decl_stmt|;
name|writeDependencies
argument_list|(
name|removed
argument_list|,
name|removedFile
argument_list|)
expr_stmt|;
name|File
name|treeListing
init|=
name|saveTreeListing
argument_list|()
decl_stmt|;
name|StringWriter
name|out
init|=
operator|new
name|StringWriter
argument_list|()
decl_stmt|;
name|out
operator|.
name|write
argument_list|(
literal|"Dependencies have changed:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|addedBundles
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|addedDependencys
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|out
operator|.
name|write
argument_list|(
literal|"\tAdded dependencies are saved here: "
operator|+
name|addedFile
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|logDependencyChanges
condition|)
block|{
name|JaxbUtil
operator|.
name|marshal
argument_list|(
name|Features
operator|.
name|class
argument_list|,
name|added
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|removedBundles
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|removedDependencys
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|out
operator|.
name|write
argument_list|(
literal|"\tRemoved dependencies are saved here: "
operator|+
name|removedFile
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|logDependencyChanges
condition|)
block|{
name|JaxbUtil
operator|.
name|marshal
argument_list|(
name|Features
operator|.
name|class
argument_list|,
name|removed
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
block|}
name|out
operator|.
name|write
argument_list|(
literal|"\tTree listing is saved here: "
operator|+
name|treeListing
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|"\n"
argument_list|)
expr_stmt|;
name|out
operator|.
name|write
argument_list|(
literal|"Delete "
operator|+
name|dependencyFile
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|" if you are happy with the dependency changes."
argument_list|)
expr_stmt|;
if|if
condition|(
name|warnOnDependencyChange
condition|)
block|{
name|getLog
argument_list|()
operator|.
name|warn
argument_list|(
name|out
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|MojoFailureException
argument_list|(
name|out
operator|.
name|toString
argument_list|()
argument_list|)
throw|;
block|}
block|}
specifier|private
name|Features
name|toFeatures
parameter_list|(
name|Collection
argument_list|<
name|Bundle
argument_list|>
name|addedBundles
parameter_list|,
name|Collection
argument_list|<
name|Dependency
argument_list|>
name|addedDependencys
parameter_list|,
name|ObjectFactory
name|objectFactory
parameter_list|)
block|{
name|Features
name|features
init|=
name|objectFactory
operator|.
name|createFeaturesRoot
argument_list|()
decl_stmt|;
name|Feature
name|feature
init|=
name|objectFactory
operator|.
name|createFeature
argument_list|()
decl_stmt|;
name|feature
operator|.
name|getBundle
argument_list|()
operator|.
name|addAll
argument_list|(
name|addedBundles
argument_list|)
expr_stmt|;
name|feature
operator|.
name|getFeature
argument_list|()
operator|.
name|addAll
argument_list|(
name|addedDependencys
argument_list|)
expr_stmt|;
name|features
operator|.
name|getFeature
argument_list|()
operator|.
name|add
argument_list|(
name|feature
argument_list|)
expr_stmt|;
return|return
name|features
return|;
block|}
specifier|private
name|void
name|writeDependencies
parameter_list|(
name|Features
name|features
parameter_list|,
name|File
name|file
parameter_list|)
throws|throws
name|JAXBException
throws|,
name|IOException
block|{
name|FileOutputStream
name|out
init|=
operator|new
name|FileOutputStream
argument_list|(
name|file
argument_list|)
decl_stmt|;
try|try
block|{
name|JaxbUtil
operator|.
name|marshal
argument_list|(
name|Features
operator|.
name|class
argument_list|,
name|features
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
specifier|protected
name|void
name|filter
parameter_list|(
name|File
name|sourceFile
parameter_list|,
name|File
name|targetFile
parameter_list|)
throws|throws
name|MojoExecutionException
block|{
try|try
block|{
if|if
condition|(
name|StringUtils
operator|.
name|isEmpty
argument_list|(
name|encoding
argument_list|)
condition|)
block|{
name|getLog
argument_list|()
operator|.
name|warn
argument_list|(
literal|"File encoding has not been set, using platform encoding "
operator|+
name|ReaderFactory
operator|.
name|FILE_ENCODING
operator|+
literal|", i.e. build is platform dependent!"
argument_list|)
expr_stmt|;
block|}
name|targetFile
operator|.
name|getParentFile
argument_list|()
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
name|List
name|filters
init|=
name|mavenFileFilter
operator|.
name|getDefaultFilterWrappers
argument_list|(
name|project
argument_list|,
literal|null
argument_list|,
literal|true
argument_list|,
name|session
argument_list|,
literal|null
argument_list|)
decl_stmt|;
name|mavenFileFilter
operator|.
name|copyFile
argument_list|(
name|sourceFile
argument_list|,
name|targetFile
argument_list|,
literal|true
argument_list|,
name|filters
argument_list|,
name|encoding
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|MavenFilteringException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|MojoExecutionException
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
specifier|protected
name|File
name|saveTreeListing
parameter_list|()
throws|throws
name|IOException
block|{
name|File
name|treeListFile
init|=
operator|new
name|File
argument_list|(
name|filteredDependencyFile
operator|.
name|getParentFile
argument_list|()
argument_list|,
literal|"treeListing.txt"
argument_list|)
decl_stmt|;
name|OutputStream
name|os
init|=
operator|new
name|FileOutputStream
argument_list|(
name|treeListFile
argument_list|)
decl_stmt|;
name|BufferedWriter
name|writer
init|=
operator|new
name|BufferedWriter
argument_list|(
operator|new
name|OutputStreamWriter
argument_list|(
name|os
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|writer
operator|.
name|write
argument_list|(
name|treeListing
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|writer
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
return|return
name|treeListFile
return|;
block|}
block|}
end_class

end_unit

